<!DOCTYPE html>
<html lang="tr"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
    <meta name="description" content="Bu yazÄ±da, eBPF yapÄ±sÄ±nÄ± kullanarak sÄ±fÄ±rdan bir paket sayacÄ± uygulamasÄ± geliÅŸtireceÄŸiz.">
  

  
    <meta property="og:image" content="https://networkop.co.uk/img/xdp-xconnect.png" />
  
  <meta property="og:site_name" content="blog" />
  <meta property="og:title" content="blog" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://msrexe.github.io" />

  <title>BPF GÃ¼nlÃ¼kleri: SÄ±fÄ±rdan Packet Counter UygulamasÄ±</title><!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="BPF GÃ¼nlÃ¼kleri: SÄ±fÄ±rdan Packet Counter UygulamasÄ±" />
<meta name="author" content="msrexe" />
<meta property="og:locale" content="tr" />
<meta name="description" content="Bu yazÄ±da, eBPF yapÄ±sÄ±nÄ± kullanarak sÄ±fÄ±rdan bir paket sayacÄ± uygulamasÄ± geliÅŸtireceÄŸiz." />
<meta property="og:description" content="Bu yazÄ±da, eBPF yapÄ±sÄ±nÄ± kullanarak sÄ±fÄ±rdan bir paket sayacÄ± uygulamasÄ± geliÅŸtireceÄŸiz." />
<link rel="canonical" href="https://msrexe.github.io/bpf-ile-packet-counter-uygulamasi.html" />
<meta property="og:url" content="https://msrexe.github.io/bpf-ile-packet-counter-uygulamasi.html" />
<meta property="og:site_name" content="blog" />
<meta property="og:image" content="https://networkop.co.uk/img/xdp-xconnect.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-29T00:00:00+03:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://networkop.co.uk/img/xdp-xconnect.png" />
<meta property="twitter:title" content="BPF GÃ¼nlÃ¼kleri: SÄ±fÄ±rdan Packet Counter UygulamasÄ±" />
<script type="application/ld+json">
{"url":"https://msrexe.github.io/bpf-ile-packet-counter-uygulamasi.html","headline":"BPF GÃ¼nlÃ¼kleri: SÄ±fÄ±rdan Packet Counter UygulamasÄ±","dateModified":"2024-05-29T00:00:00+03:00","datePublished":"2024-05-29T00:00:00+03:00","author":{"@type":"Person","name":"msrexe"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://msrexe.github.io/bpf-ile-packet-counter-uygulamasi.html"},"description":"Bu yazÄ±da, eBPF yapÄ±sÄ±nÄ± kullanarak sÄ±fÄ±rdan bir paket sayacÄ± uygulamasÄ± geliÅŸtireceÄŸiz.","@type":"BlogPosting","image":"https://networkop.co.uk/img/xdp-xconnect.png","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="https://msrexe.github.io/feed.xml" title="blog" /><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="/assets/css/main.css" />
</head>
<body a="dark">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <div class="back-link"><a href="/">â† Home</a></div>

<article>
  <h1>BPF GÃ¼nlÃ¼kleri: SÄ±fÄ±rdan Packet Counter UygulamasÄ±</h1><p class="post-meta">
    <time datetime="2024-05-29 00:00:00 +0300">May 29, 2024</time>
    <span class="read-time">ğŸ“– 4 min read</span><span class="lang-tag">ğŸŒ TR</span><span class="category">linux</span></p><p class="post-description">Bu yazÄ±da, eBPF yapÄ±sÄ±nÄ± kullanarak sÄ±fÄ±rdan bir paket sayacÄ± uygulamasÄ± geliÅŸtireceÄŸiz.</p><p><img src="https://networkop.co.uk/img/xdp-xconnect.png" alt="eBPF XDP" /></p>

<p>Bu yazÄ±da, eBPF yapÄ±sÄ±nÄ± kullanarak sÄ±fÄ±rdan bir paket sayacÄ± uygulamasÄ± geliÅŸtireceÄŸiz. UygulamamÄ±zÄ± C dili ile yazdÄ±ktan sonra Ciliumâ€™un <code class="language-plaintext highlighter-rouge">bpf2go</code> aracÄ± ile derleyeceÄŸiz. SonrasÄ±nda uygulamamÄ±zÄ± kernelâ€™a atacaÄŸÄ±mÄ±z bir Go kodu ile yazÄ±mÄ±zÄ± tamamlayacaÄŸÄ±z. Åimdi malzeme listesiyle baÅŸlayalÄ±m.</p>

<h3 id="gereksinimler">Gereksinimler</h3>
<ul>
  <li>Linux (BPF desteÄŸi olan bir kernel)</li>
  <li>Clang ve LLVM (eBPF programlarÄ±nÄ± derlemek iÃ§in)</li>
  <li>Go (eBPF programlarÄ±nÄ± yÃ¼klemek ve kontrol etmek iÃ§in)</li>
</ul>

<h3 id="uygulama">Uygulama</h3>
<ul>
  <li>Ã–ncelikle eBPF ile Ã§alÄ±ÅŸacak programÄ±mÄ±zÄ± yazalÄ±m. Bu program, gelen paketleri sayacak ve bir sayaÃ§ deÄŸerini arttÄ±racak.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//go:build ignore</span>

<span class="cp">#include</span> <span class="cpf">&lt;linux/bpf.h&gt;</span><span class="c1"> // Bu header dosyasÄ± her kernel sÃ¼rÃ¼mÃ¼ iÃ§in farklÄ±lÄ±k gÃ¶sterir. "apt-get install linux-headers-$(uname -r)" komutu ile kernelinize uygun header dosyalarÄ±nÄ± yÃ¼kleyebilirsiniz</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="p">{</span>
    <span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">);</span>
    <span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">__u32</span><span class="p">);</span>
    <span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">__u64</span><span class="p">);</span>
    <span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> <span class="n">pkt_count</span> <span class="nf">SEC</span><span class="p">(</span><span class="s">".maps"</span><span class="p">);</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">"xdp"</span><span class="p">)</span> <span class="c1">// XDP hook'unu kullanarak Ã§alÄ±ÅŸacak</span>
<span class="kt">int</span> <span class="nf">count_packets</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">__u32</span> <span class="n">key</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">__u64</span> <span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__sync_fetch_and_add</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">XDP_PASS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>ArdÄ±ndan, bu programÄ± <code class="language-plaintext highlighter-rouge">bpf2go</code> aracÄ± ile derleyebilmemizi saÄŸlayacak Go programÄ±nÄ± yazalÄ±m.</li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="c">//go:generate go run github.com/cilium/ebpf/cmd/bpf2go counter counter.c</span>
</code></pre></div></div>

<ul>
  <li>Åimdi, bu Go kodunu Ã§alÄ±ÅŸtÄ±rarak C kodumuzu derleyelim.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go mod init ebpf-test <span class="o">&amp;&amp;</span> go mod tidy

go generate
</code></pre></div></div>

<ul>
  <li>Derleme iÅŸlemi baÅŸarÄ±lÄ± bir ÅŸekilde tamamlandÄ±ysa birkaÃ§ tane dosya oluÅŸmuÅŸ olmalÄ±.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">counter_bpfeb.go</code></li>
      <li><code class="language-plaintext highlighter-rouge">counter_bpfel.go</code></li>
      <li><code class="language-plaintext highlighter-rouge">counter_bpfeb.o</code></li>
      <li><code class="language-plaintext highlighter-rouge">counter_bpfel.o</code></li>
    </ul>
  </li>
  <li>
    <p>Not: Go kodlarÄ±nÄ± incelediÄŸimizde kernelâ€™a yÃ¼kleyeceÄŸimiz programdan okuma iÅŸlemleri yapmak iÃ§in gerekli yapÄ±larÄ± oluÅŸturduÄŸunu gÃ¶rebiliriz.</p>
  </li>
  <li>Son olarak, bu programÄ± kernele yÃ¼kleyecek ve kontrol edecek Go kodunu yazalÄ±m ve Ã§alÄ±ÅŸtÄ±ralÄ±m.</li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"log"</span>
    <span class="s">"net"</span>
    <span class="s">"os"</span>
    <span class="s">"os/signal"</span>
    <span class="s">"time"</span>

    <span class="s">"github.com/cilium/ebpf/link"</span>
    <span class="s">"github.com/cilium/ebpf/rlimit"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c">// Remove resource limits for kernels &lt;5.11.</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">rlimit</span><span class="o">.</span><span class="n">RemoveMemlock</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span> 
        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"Removing memlock:"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c">// Load the compiled eBPF ELF and load it into the kernel.</span>
    <span class="k">var</span> <span class="n">objs</span> <span class="n">counterObjects</span> 
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">loadCounterObjects</span><span class="p">(</span><span class="o">&amp;</span><span class="n">objs</span><span class="p">,</span> <span class="no">nil</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"Loading eBPF objects:"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="n">objs</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span> 

    <span class="n">ifname</span> <span class="o">:=</span> <span class="s">"eth0"</span> <span class="c">// Change this to an interface on your machine.</span>
    <span class="n">iface</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">net</span><span class="o">.</span><span class="n">InterfaceByName</span><span class="p">(</span><span class="n">ifname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Getting interface %s: %s"</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c">// Attach count_packets to the network interface.</span>
    <span class="n">link</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">link</span><span class="o">.</span><span class="n">AttachXDP</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">XDPOptions</span><span class="p">{</span> 
        <span class="n">Program</span><span class="o">:</span>   <span class="n">objs</span><span class="o">.</span><span class="n">CountPackets</span><span class="p">,</span>
        <span class="n">Interface</span><span class="o">:</span> <span class="n">iface</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"Attaching XDP:"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="n">link</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span> 

    <span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Counting incoming packets on %s.."</span><span class="p">,</span> <span class="n">ifname</span><span class="p">)</span>

    <span class="c">// Periodically fetch the packet counter from PktCount,</span>
    <span class="c">// exit the program when interrupted.</span>
    <span class="n">tick</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Tick</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="n">os</span><span class="o">.</span><span class="n">Signal</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">Notify</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="n">tick</span><span class="o">:</span>
            <span class="k">var</span> <span class="n">count</span> <span class="kt">uint64</span>
            <span class="n">err</span> <span class="o">:=</span> <span class="n">objs</span><span class="o">.</span><span class="n">PktCount</span><span class="o">.</span><span class="n">Lookup</span><span class="p">(</span><span class="kt">uint32</span><span class="p">(</span><span class="m">0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"Map lookup:"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Received %d packets"</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="n">stop</span><span class="o">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">Print</span><span class="p">(</span><span class="s">"Received signal, exiting.."</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go run main.go
</code></pre></div></div>

<ul>
  <li>Terminalde ÅŸunu gÃ¶rdÃ¼yseniz ilk eBPF uygulamanÄ±zÄ± baÅŸarÄ±yla geliÅŸtirdiniz demektir.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msrexe@ubuntu:~/ebpf-test<span class="nv">$ </span><span class="nb">sudo </span>go run <span class="nb">.</span>
2024/05/29 23:41:44 Counting incoming packets on eth0..
2024/05/29 23:41:45 Received 0 packets
2024/05/29 23:41:50 Received 0 packets
2024/05/29 23:41:51 Received 1 packets
2024/05/29 23:41:54 Received 3 packets
2024/05/29 23:41:55 Received 4 packets
</code></pre></div></div>

<h3 id="sonuÃ§">SonuÃ§</h3>
<p>Bu yazÄ±da, eBPF yapÄ±sÄ±nÄ± kullanarak sÄ±fÄ±rdan bir paket sayacÄ± uygulamasÄ± geliÅŸtirdik. Bu uygulamada eÄŸer linux/bpf.h sebebiyle hata aldÄ±ysanÄ±z ve kernel headerlarÄ± ile Ã§ok uÄŸraÅŸtÄ±ysanÄ±z bir sonraki yazÄ±da anlatacaÄŸÄ±m portable bpf uygulamalarÄ± geliÅŸtirmek iÃ§in kullanÄ±lan <a href="https://thegraynode.io/posts/portable_bpf_programs/">BPF CO-RE</a> yapÄ±sÄ±nÄ± inceleyebilirsiniz.</p>

<h4 id="kaynaklar">Kaynaklar</h4>
<ul>
  <li><a href="https://ebpf-go.dev/guides/getting-started">Getting Started with eBPF and Go</a></li>
</ul>
</article>
      </div>
    </main>
    
    <!-- Post filter script -->
    <script type="text/javascript" src="/assets/js/post-filter.js"></script>
  </body>
</html>